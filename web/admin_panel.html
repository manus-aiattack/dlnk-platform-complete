<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dLNk HACK - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background: rgba(26, 31, 58, 0.95);
            border-right: 1px solid rgba(0, 255, 136, 0.3);
            padding: 20px;
            overflow-y: auto;
        }

        .logo {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            margin-bottom: 30px;
            text-align: center;
        }

        .menu {
            list-style: none;
        }

        .menu-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00ff88;
        }

        .menu-item.active {
            background: rgba(0, 255, 136, 0.2);
            border-left: 3px solid #00ff88;
        }

        .menu-icon {
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        .header {
            background: rgba(26, 31, 58, 0.95);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            color: #00ff88;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #0a0e27;
            font-weight: bold;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }

        .btn-danger {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid #ff3b30;
            color: #ff3b30;
        }

        .btn-danger:hover {
            background: rgba(255, 59, 48, 0.3);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(26, 31, 58, 0.8);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 20px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #b0b0b0;
        }

        /* Content Section */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: rgba(26, 31, 58, 0.8);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            color: #00ff88;
            margin-bottom: 20px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            color: #00ff88;
            font-weight: bold;
        }

        tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-admin {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: 1px solid #ff9800;
        }

        .badge-user {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
            border: 1px solid #2196f3;
        }

        .badge-viewer {
            background: rgba(156, 39, 176, 0.2);
            color: #9c27b0;
            border: 1px solid #9c27b0;
        }

        .badge-active {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }

        .badge-inactive {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: rgba(10, 14, 39, 0.8);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(26, 31, 58, 0.95);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 24px;
            color: #00ff88;
        }

        .btn-close {
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 24px;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top: 3px solid #00ff88;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #0a0e27;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">dLNk HACK<br>Admin Panel</div>
        
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">A</div>
            <div>
                <div style="font-weight: bold;" id="userName">Admin</div>
                <div style="font-size: 12px; color: #b0b0b0;" id="userRole">Administrator</div>
            </div>
        </div>

        <ul class="menu">
            <li class="menu-item active" onclick="showSection('dashboard')">
                <span class="menu-icon">üìä</span>
                <span>Dashboard</span>
            </li>
            <li class="menu-item" onclick="showSection('users')">
                <span class="menu-icon">üë•</span>
                <span>Users</span>
            </li>
            <li class="menu-item" onclick="showSection('licenses')">
                <span class="menu-icon">üîë</span>
                <span>Licenses</span>
            </li>
            <li class="menu-item" onclick="showSection('agents')">
                <span class="menu-icon">ü§ñ</span>
                <span>Agents</span>
            </li>
            <li class="menu-item" onclick="showSection('workflows')">
                <span class="menu-icon">‚ö°</span>
                <span>Workflows</span>
            </li>
            <li class="menu-item" onclick="showSection('logs')">
                <span class="menu-icon">üìù</span>
                <span>Logs</span>
            </li>
            <li class="menu-item" onclick="showSection('settings')">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </li>
            <li class="menu-item" onclick="logout()">
                <span class="menu-icon">üö™</span>
                <span>Logout</span>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div class="content-section active" id="dashboard">
            <div class="header">
                <h1 class="header-title">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeAgents">0</div>
                    <div class="stat-label">Active Agents</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="runningWorkflows">0</div>
                    <div class="stat-label">Running Workflows</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeLicenses">0</div>
                    <div class="stat-label">Active Licenses</div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">Recent Activity</h2>
                <div id="recentActivity">
                    <p style="color: #b0b0b0;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div class="content-section" id="users">
            <div class="header">
                <h1 class="header-title">User Management</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('createUserModal')">
                        ‚ûï Create User
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>Loading users...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Licenses Section -->
        <div class="content-section" id="licenses">
            <div class="header">
                <h1 class="header-title">License Management</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('createLicenseModal')">
                        ‚ûï Generate License
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="table-container">
                    <table id="licensesTable">
                        <thead>
                            <tr>
                                <th>License Key</th>
                                <th>Type</th>
                                <th>Organization</th>
                                <th>Status</th>
                                <th>Expires</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    <p style="color: #b0b0b0;">No licenses found</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Agents Section -->
        <div class="content-section" id="agents">
            <div class="header">
                <h1 class="header-title">Agent Status</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="refreshAgents()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>

            <div class="card">
                <p style="color: #b0b0b0;">Agent monitoring coming soon...</p>
            </div>
        </div>

        <!-- Workflows Section -->
        <div class="content-section" id="workflows">
            <div class="header">
                <h1 class="header-title">Workflow Management</h1>
            </div>

            <div class="card">
                <p style="color: #b0b0b0;">Workflow management coming soon...</p>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="content-section" id="logs">
            <div class="header">
                <h1 class="header-title">System Logs</h1>
            </div>

            <div class="card">
                <p style="color: #b0b0b0;">Log viewer coming soon...</p>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="content-section" id="settings">
            <div class="header">
                <h1 class="header-title">Settings</h1>
            </div>

            <div class="card">
                <h2 class="card-title">System Configuration</h2>
                <p style="color: #b0b0b0;">Settings panel coming soon...</p>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal" id="createUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New User</h2>
                <button class="btn-close" onclick="closeModal('createUserModal')">√ó</button>
            </div>
            <form id="createUserForm" onsubmit="createUser(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required minlength="8">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select name="role">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Create User
                </button>
            </form>
        </div>
    </div>

    <!-- Create License Modal -->
    <div class="modal" id="createLicenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Generate License</h2>
                <button class="btn-close" onclick="closeModal('createLicenseModal')">√ó</button>
            </div>
            <form id="createLicenseForm" onsubmit="createLicense(event)">
                <div class="form-group">
                    <label>Organization</label>
                    <input type="text" name="organization" required>
                </div>
                <div class="form-group">
                    <label>License Type</label>
                    <select name="license_type">
                        <option value="trial">Trial</option>
                        <option value="basic">Basic</option>
                        <option value="professional">Professional</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Duration (days)</label>
                    <input type="number" name="duration_days" value="365" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Generate License
                </button>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000';
        let currentToken = localStorage.getItem('access_token');

        // Check authentication
        if (!currentToken) {
            window.location.href = 'dashboard_dlnk.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentUser();
            loadDashboardStats();
            loadUsers();
        });

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.menu-item').classList.add('active');
            
            // Load data for section
            if (sectionId === 'users') {
                loadUsers();
            } else if (sectionId === 'licenses') {
                loadLicenses();
            }
        }

        // Load current user
        async function loadCurrentUser() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const user = result.data;
                    
                    document.getElementById('userName').textContent = user.username;
                    document.getElementById('userRole').textContent = user.role;
                    document.getElementById('userAvatar').textContent = user.username[0].toUpperCase();
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        // Load dashboard stats
        async function loadDashboardStats() {
            // Simulate stats (replace with real API calls)
            document.getElementById('totalUsers').textContent = '12';
            document.getElementById('activeAgents').textContent = '62';
            document.getElementById('runningWorkflows').textContent = '3';
            document.getElementById('activeLicenses').textContent = '8';
            
            document.getElementById('recentActivity').innerHTML = `
                <p style="color: #b0b0b0;">‚Ä¢ User 'testuser' logged in</p>
                <p style="color: #b0b0b0;">‚Ä¢ Workflow 'advanced_attack' started</p>
                <p style="color: #b0b0b0;">‚Ä¢ License 'DLNK-ENT-001' activated</p>
            `;
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/users`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const users = result.data;
                    
                    const tbody = document.querySelector('#usersTable tbody');
                    tbody.innerHTML = '';
                    
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td><span class="badge badge-${user.role}">${user.role.toUpperCase()}</span></td>
                            <td><span class="badge badge-${user.is_active ? 'active' : 'inactive'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-sm" onclick="editUser('${user.username}')">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.username}')">Delete</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Create user
        async function createUser(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: formData.get('username'),
                        email: formData.get('email'),
                        password: formData.get('password'),
                        role: formData.get('role')
                    })
                });
                
                if (response.ok) {
                    alert('User created successfully!');
                    closeModal('createUserModal');
                    loadUsers();
                    event.target.reset();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error creating user: ' + error.message);
            }
        }

        // Delete user
        async function deleteUser(username) {
            if (!confirm(`Delete user '${username}'?`)) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/users/${username}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    alert('User deleted successfully!');
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error deleting user: ' + error.message);
            }
        }

        // Load licenses
        function loadLicenses() {
            // Placeholder
            console.log('Loading licenses...');
        }

        // Create license
        async function createLicense(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`${API_BASE_URL}/license/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        organization: formData.get('organization'),
                        license_type: formData.get('license_type'),
                        duration_days: parseInt(formData.get('duration_days'))
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('License generated!\n\nKey: ' + result.license_key);
                    closeModal('createLicenseModal');
                    loadLicenses();
                    event.target.reset();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error generating license: ' + error.message);
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Refresh functions
        function refreshDashboard() {
            loadDashboardStats();
        }

        function refreshAgents() {
            console.log('Refreshing agents...');
        }

        // Logout
        function logout() {
            if (confirm('Logout?')) {
                localStorage.removeItem('access_token');
                window.location.href = 'dashboard_dlnk.html';
            }
        }

        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>

