<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dLNk - Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e0e0;
            overflow-x: hidden;
        }

        header {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            padding: 20px;
            border-bottom: 2px solid #00d4ff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        header h1 {
            color: #00d4ff;
            font-size: 28px;
            margin-bottom: 5px;
        }

        header p {
            color: #a0a0a0;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid #00d4ff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #00ff88;
            box-shadow: 0 8px 12px rgba(0, 212, 255, 0.2);
            transform: translateY(-2px);
        }

        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-label {
            color: #a0a0a0;
            font-size: 14px;
        }

        .status-value {
            color: #00d4ff;
            font-weight: bold;
            font-size: 16px;
        }

        .status-value.success {
            color: #00ff88;
        }

        .status-value.error {
            color: #ff4444;
        }

        .status-value.warning {
            color: #ffaa00;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        button:hover {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            transform: scale(1.05);
        }

        button:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            transform: scale(1);
        }

        .logs-container {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid #00d4ff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #00d4ff;
            padding-left: 15px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            color: #a0a0a0;
        }

        .log-entry.info {
            border-left-color: #00d4ff;
            color: #00d4ff;
        }

        .log-entry.success {
            border-left-color: #00ff88;
            color: #00ff88;
        }

        .log-entry.error {
            border-left-color: #ff4444;
            color: #ff4444;
        }

        .log-entry.warning {
            border-left-color: #ffaa00;
            color: #ffaa00;
        }

        .connection-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-weight: bold;
        }

        .connection-status.connected {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
        }

        .connection-status.disconnected {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
        }

        .spinner {
            border: 4px solid rgba(0, 212, 255, 0.3);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>⚡ dLNk - Monitoring Dashboard</h1>
        <p>ระบบตรวจสอบและควบคุมแบบเรียลไทม์</p>
    </header>

    <div class="container">
        <!-- Connection Status -->
        <div class="connection-status" id="connectionStatus">
            <div class="spinner"></div>
            กำลังเชื่อมต่อ...
        </div>

        <!-- Status Cards -->
        <div class="grid">
            <div class="card">
                <h3 style="color: #00d4ff; margin-bottom: 15px;">สถานะระบบ</h3>
                <div class="status">
                    <span class="status-label">สถานะ:</span>
                    <span class="status-value" id="systemStatus">กำลังตรวจสอบ...</span>
                </div>
                <div class="status">
                    <span class="status-label">เอเย่นต์:</span>
                    <span class="status-value" id="agentCount">0</span>
                </div>
                <div class="status">
                    <span class="status-label">ผลลัพธ์:</span>
                    <span class="status-value" id="resultCount">0</span>
                </div>
                <div class="status">
                    <span class="status-label">เฟสปัจจุบัน:</span>
                    <span class="status-value" id="currentPhase">-</span>
                </div>
            </div>

            <div class="card">
                <h3 style="color: #00d4ff; margin-bottom: 15px;">การดำเนินการด่วน</h3>
                <div class="button-group">
                    <button onclick="runWorkflow()">รันเวิร์กโฟลว์</button>
                    <button onclick="executeAgent()">รันเอเย่นต์</button>
                    <button onclick="refreshData()">รีเฟรชข้อมูล</button>
                    <button onclick="exportResults()">ส่งออกผลลัพธ์</button>
                </div>
            </div>

            <div class="card">
        <h3 style="color: #00d4ff; margin-bottom: 15px;">ข้อมูลระบบ</h3>
                <div class="status">
                    <span class="status-label">API Endpoint:</span>
                    <span class="status-value" id="apiEndpoint">http://localhost:8000</span>
                </div>
                <div class="status">
                    <span class="status-label">เวลาทำงาน:</span>
                    <span class="status-value" id="uptime">0s</span>
                </div>
                <div class="status">
                    <span class="status-label">อัพเดตล่าสุด:</span>
                    <span class="status-value" id="lastUpdate">-</span>
                </div>
            </div>
        </div>

        <!-- Agent List -->
        <div class="card">
            <h3 style="color: #00d4ff; margin-bottom: 15px;">เอเย่นต์ที่พร้อมใช้งาน</h3>
            <div class="agent-grid" id="agentList">
                <div style="text-align: center; color: #a0a0a0;">กำลังโหลดเอเย่นต์...</div>
            </div>
        </div>

        <!-- Live Logs -->
        <div class="card">
            <h3 style="color: #00d4ff; margin-bottom: 15px;">บันทึกแบบเรียลไทม์</h3>
            <div class="logs-container" id="logsContainer">
                <div class="log-entry info">ระบบเริ่มทำงาน...</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="workflowModal" class="modal" style="display: none;">
        <div class="modal-content" style="background: #1a1a2e; padding: 30px; border-radius: 8px; margin: 5% auto; width: 90%; max-width: 500px; border: 1px solid #00d4ff;">
            <span class="close" onclick="closeModal('workflowModal')" style="float: right; font-size: 28px; font-weight: bold; color: #00d4ff; cursor: pointer;">×</span>
            <h3 style="color: #00d4ff; margin-bottom: 20px;">รันเวิร์กโฟลว์</h3>
            <input type="text" id="workflowPath" placeholder="เส้นทางเวิร์กโฟลว์ (เช่น config/default_workflow.yaml)" value="config/default_workflow.yaml" style="width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid #00d4ff; border-radius: 4px; color: #e0e0e0; font-family: 'Courier New', monospace;">
            <input type="text" id="targetUrl" placeholder="URL เป้าหมาย (เช่น http://example.com)" style="width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid #00d4ff; border-radius: 4px; color: #e0e0e0; font-family: 'Courier New', monospace;">
            <input type="text" id="targetName" placeholder="ชื่อเป้าหมาย (เช่น Example Web App)" style="width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid #00d4ff; border-radius: 4px; color: #e0e0e0; font-family: 'Courier New', monospace;">
            <button onclick="submitWorkflow()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); color: #000; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">ส่ง</button>
        </div>
    </div>

    <div id="agentModal" class="modal" style="display: none;">
        <div class="modal-content" style="background: #1a1a2e; padding: 30px; border-radius: 8px; margin: 5% auto; width: 90%; max-width: 500px; border: 1px solid #00d4ff;">
            <span class="close" onclick="closeModal('agentModal')" style="float: right; font-size: 28px; font-weight: bold; color: #00d4ff; cursor: pointer;">×</span>
            <h3 style="color: #00d4ff; margin-bottom: 20px;">รันเอเย่นต์</h3>
            <input type="text" id="agentName" placeholder="ชื่อเอเย่นต์ (เช่น NmapScanAgent)" style="width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid #00d4ff; border-radius: 4px; color: #e0e0e0; font-family: 'Courier New', monospace;">
            <input type="text" id="agentDirective" placeholder="คำสั่ง (เช่น สแกนพอร์ต 1-1000)" style="width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid #00d4ff; border-radius: 4px; color: #e0e0e0; font-family: 'Courier New', monospace;">
            <textarea id="agentContext" placeholder="บริบท (รูปแบบ JSON)" rows="4" style="width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid #00d4ff; border-radius: 4px; color: #e0e0e0; font-family: 'Courier New', monospace;"></textarea>
            <button onclick="submitAgent()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); color: #000; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">ส่ง</button>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'http://localhost:8000';
        let startTime = new Date();
        let ws = null;
        let connectionStatus = 'disconnected';

        // Initialize dashboard
        async function initDashboard() {
            await refreshData();
            connectWebSocket();
            setInterval(refreshData, 5000);
            setInterval(updateUptime, 1000);
        }

        // Connect to WebSocket
        function connectWebSocket() {
            const statusEl = document.getElementById('connectionStatus');

            try {
                ws = new WebSocket('ws://localhost:8000/ws/logs');

                ws.onopen = () => {
                    connectionStatus = 'connected';
                    statusEl.innerHTML = '<span style="color: #00ff88;">🟢 เชื่อมต่อสำเร็จ</span>';
                    addLog({ message: 'เชื่อมต่อกับระบบบันทึกแบบเรียลไทม์สำเร็จ', level: 'success' });
                };

                ws.onmessage = (event) => {
                    try {
                        const logData = JSON.parse(event.data);
                        addLog(logData);
                    } catch (error) {
                        console.error('Error parsing log data:', error);
                    }
                };

                ws.onclose = () => {
                    connectionStatus = 'disconnected';
                    statusEl.innerHTML = '<span style="color: #ff4444;">🔴 ถูกตัดการเชื่อมต่อ</span>';
                    setTimeout(connectWebSocket, 3000);
                };

                ws.onerror = (error) => {
                    connectionStatus = 'error';
                    statusEl.innerHTML = '<span style="color: #ff4444;">❌ เกิดข้อผิดพลาด</span>';
                    console.error('WebSocket error:', error);
                };

            } catch (error) {
                connectionStatus = 'error';
                statusEl.innerHTML = '<span style="color: #ff4444;">❌ เกิดข้อผิดพลาดในการเชื่อมต่อ</span>';
                console.error('WebSocket connection failed:', error);
            }
        }

        // Refresh all data
        async function refreshData() {
            try {
                const response = await fetch(`${API_ENDPOINT}/status`);
                const data = await response.json();

                document.getElementById('systemStatus').textContent = data.running ? 'กำลังทำงาน' : 'ว่าง';
                document.getElementById('systemStatus').className = 'status-value ' + (data.running ? 'success' : 'warning');
                document.getElementById('agentCount').textContent = data.agents_registered || 0;
                document.getElementById('resultCount').textContent = data.results_count || 0;
                document.getElementById('currentPhase').textContent = data.current_phase || '-';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error refreshing data:', error);
                document.getElementById('systemStatus').textContent = 'ไม่สามารถเชื่อมต่อ';
                document.getElementById('systemStatus').className = 'status-value error';
            }

            // Load agents
            loadAgents();
        }

        // Load agents
        async function loadAgents() {
            try {
                const response = await fetch(`${API_ENDPOINT}/agents`);
                const data = await response.json();

                const agentsList = document.getElementById('agentList');
                agentsList.innerHTML = '';

                if (data.agents && data.agents.length > 0) {
                    data.agents.forEach(agent => {
                        const agentItem = document.createElement('div');
                        agentItem.style.background = 'rgba(0, 212, 255, 0.1)';
                        agentItem.style.border = '1px solid #00d4ff';
                        agentItem.style.borderRadius = '5px';
                        agentItem.style.padding = '12px';
                        agentItem.style.margin = '5px';
                        agentItem.style.textAlign = 'center';
                        agentItem.style.cursor = 'pointer';
                        agentItem.style.transition = 'all 0.3s ease';

                        agentItem.innerHTML = `
                            <div style="color: #00d4ff; font-weight: bold;">${agent.name}</div>
                            <div style="color: #a0a0a0; font-size: 12px;">สถานะ: ${agent.status || 'unknown'}</div>
                        `;

                        agentItem.onclick = () => selectAgent(agent.name);
                        agentItem.onmouseover = () => {
                            agentItem.style.background = 'rgba(0, 212, 255, 0.2)';
                            agentItem.style.borderColor = '#00ff88';
                        };
                        agentItem.onmouseout = () => {
                            agentItem.style.background = 'rgba(0, 212, 255, 0.1)';
                            agentItem.style.borderColor = '#00d4ff';
                        };

                        agentsList.appendChild(agentItem);
                    });
                } else {
                    agentsList.innerHTML = '<div style="text-align: center; color: #a0a0a0; padding: 20px;">ไม่มีเอเย่นต์พร้อมใช้งาน</div>';
                }
            } catch (error) {
                console.error('Error loading agents:', error);
                document.getElementById('agentList').innerHTML = '<div style="text-align: center; color: #ff4444;">ไม่สามารถโหลดเอเย่นต์ได้</div>';
            }
        }

        // Select agent
        function selectAgent(agentName) {
            document.getElementById('agentName').value = agentName;
            openModal('agentModal');
        }

        // Update uptime
        function updateUptime() {
            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;

            let uptimeStr = '';
            if (hours > 0) uptimeStr += hours + 'ชม ';
            if (minutes > 0) uptimeStr += minutes + 'น ';
            uptimeStr += seconds + 'ว';

            document.getElementById('uptime').textContent = uptimeStr;
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Run workflow
        function runWorkflow() {
            openModal('workflowModal');
        }

        // Submit workflow
        async function submitWorkflow() {
            const workflowPath = document.getElementById('workflowPath').value;
            const targetUrl = document.getElementById('targetUrl').value;
            const targetName = document.getElementById('targetName').value;

            if (!workflowPath || !targetUrl || !targetName) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            try {
                const response = await fetch(`${API_ENDPOINT}/workflows/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        workflow_path: workflowPath,
                        target: {
                            name: targetName,
                            url: targetUrl
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                addLog({ message: 'เวิร์กโฟลว์เริ่มทำงาน: ' + data.message, level: 'success' });
                closeModal('workflowModal');
            } catch (error) {
                addLog({ message: 'เกิดข้อผิดพลาดในการเริ่มเวิร์กโฟลว์: ' + error.message, level: 'error' });
            }
        }

        // Execute agent
        function executeAgent() {
            openModal('agentModal');
        }

        // Submit agent
        async function submitAgent() {
            const agentName = document.getElementById('agentName').value;
            const agentDirective = document.getElementById('agentDirective').value;
            const agentContext = document.getElementById('agentContext').value;

            if (!agentName || !agentDirective) {
                alert('กรุณากรอกชื่อเอเย่นต์และคำสั่ง');
                return;
            }

            let contextObj = {};
            if (agentContext) {
                try {
                    contextObj = JSON.parse(agentContext);
                } catch (parseError) {
                    alert('รูปแบบ JSON ไม่ถูกต้อง: ' + parseError.message);
                    return;
                }
            }

            try {
                const response = await fetch(`${API_ENDPOINT}/agents/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent_name: agentName,
                        directive: agentDirective,
                        context: contextObj
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                addLog({ message: `เอเย่นต์ ${agentName} เริ่มทำงาน: ${data.summary}`, level: data.success ? 'success' : 'error' });
                closeModal('agentModal');
            } catch (error) {
                addLog({ message: 'เกิดข้อผิดพลาดในการรันเอเย่นต์: ' + error.message, level: 'error' });
            }
        }

        // View logs
        function viewLogs() {
            alert('บันทึกจะแสดงในส่วนบันทึกแบบเรียลไทม์ด้านล่าง');
        }

        // Export results
        function exportResults() {
            alert('ฟังก์ชันส่งออกผลลัพธ์กำลังพัฒนา...');
        }

        // Add log entry
        function addLog(logData) {
            const logsContainer = document.getElementById('logsContainer');
            const logEntry = document.createElement('div');

            let level = logData.level ? logData.level.toLowerCase() : 'info';
            if (level === 'success') level = 'success';
            if (level === 'phase') level = 'info';

            let message = `[${new Date(logData.timestamp).toLocaleTimeString()}]`;
            if (logData.agent_name) message += ` [${logData.agent_name}]`;
            if (logData.workflow_id) message += ` [WF:${logData.workflow_id.substring(0, 8)}]`;
            if (logData.target_id) message += ` [เป้าหมาย:${logData.target_id}]`;
            message += ` ${logData.message}`;

            logEntry.className = `log-entry ${level}`;
            logEntry.textContent = message;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const workflowModal = document.getElementById('workflowModal');
            const agentModal = document.getElementById('agentModal');

            if (event.target === workflowModal) {
                workflowModal.style.display = 'none';
            }
            if (event.target === agentModal) {
                agentModal.style.display = 'none';
            }
        }

        // Initialize on page load
        window.onload = initDashboard;
    </script>
</body>
</html>