input {
  # File input for application logs
  file {
    path => "/var/log/manus/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    tags => ["manus", "application"]
  }
  
  # Beats input (if using Filebeat)
  beats {
    port => 5044
    tags => ["beats"]
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{/ {
    json {
      source => "message"
    }
  }
  
  # Add timestamp
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }
  
  # Parse log level
  if [level] {
    mutate {
      uppercase => [ "level" ]
    }
  }
  
  # Add environment
  mutate {
    add_field => {
      "environment" => "production"
      "application" => "manus-attack-platform"
    }
  }
  
  # Parse attack logs
  if [event_type] == "attack" {
    mutate {
      add_tag => ["attack"]
    }
  }
  
  # Parse vulnerability logs
  if [event_type] == "vulnerability" {
    mutate {
      add_tag => ["vulnerability"]
    }
    
    # Add CVSS severity tag
    if [cvss_score] {
      ruby {
        code => "
          score = event.get('cvss_score').to_f
          if score >= 9.0
            event.set('cvss_severity', 'critical')
          elsif score >= 7.0
            event.set('cvss_severity', 'high')
          elsif score >= 4.0
            event.set('cvss_severity', 'medium')
          else
            event.set('cvss_severity', 'low')
          end
        "
      }
    }
  }
  
  # Parse error logs
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_tag => ["error"]
    }
  }
  
  # GeoIP lookup for IP addresses
  if [source_ip] {
    geoip {
      source => "source_ip"
      target => "geoip"
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "manus-%{+YYYY.MM.dd}"
    
    # Create separate indices for different log types
    if "attack" in [tags] {
      index => "manus-attacks-%{+YYYY.MM.dd}"
    } else if "vulnerability" in [tags] {
      index => "manus-vulnerabilities-%{+YYYY.MM.dd}"
    } else if "error" in [tags] {
      index => "manus-errors-%{+YYYY.MM.dd}"
    }
  }
  
  # Debug output (optional, remove in production)
  # stdout {
  #   codec => rubydebug
  # }
}

